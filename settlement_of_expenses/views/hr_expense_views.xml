<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Heredar vista de hoja de gastos -->
    <record id="view_expense_sheet_form_inherit_settlement" model="ir.ui.view">
        <field name="name">hr.expense.sheet.form.inherit.settlement</field>
        <field name="model">hr.expense.sheet</field>
        <field name="inherit_id" ref="hr_expense.hr_expense_sheet_view_form"/>
        <field name="arch" type="xml">

            <!-- Agregar pestaña de solicitud después de la pestaña "Expenses" -->
            <xpath expr="//page[@name='expense_ids']" position="after">
                <page name="trip_request" string="Request for Expenses and Travel">
                    <group>
                        <group string="Destination" name="destination_group" col="4">
                            <field name="destination" colspan="4"/>
                            <field name="justification" nolabel="1" colspan="4"/>
                        </group>
                    </group>

                    <separator string="Trip Details"/>

                    <group>
                        <group string="Expenses" name="expenses_group" col="2">
                            <field name="overnight"/>
                            <field name="date_since"
                                   attrs="{'invisible': [('overnight', '=', False)], 'required': [('overnight', '=', True)]}"/>
                            <field name="date_up"
                                   attrs="{'invisible': [('overnight', '=', False)], 'required': [('overnight', '=', True)]}"/>
                            <field name="number_days"
                                   attrs="{'invisible': [('overnight', '=', False)]}"/>
                        </group>

                        <group string="Tickets" name="tickets_group" col="2">
                            <field name="ticket_type"/>
                            <field name="flight_date"
                                   attrs="{'invisible': [('ticket_type', '!=', 'air')], 'required': [('ticket_type', '=', 'air')]}"/>
                            <field name="airline"
                                   attrs="{'invisible': [('ticket_type', '!=', 'air')]}"/>
                            <field name="route"
                                   attrs="{'invisible': [('ticket_type', '!=', 'air')]}"/>
                            <field name="flight"
                                   attrs="{'invisible': [('ticket_type', '!=', 'air')]}"/>
                        </group>
                    </group>
                </page>
            </xpath>

            <!-- Agregar información de liquidación en el header -->
            <xpath expr="//field[@name='state']" position="after">
                <field name="liquidation_state"
                       widget="badge"
                       attrs="{'invisible': [('is_liquidation', '=', True)]}"
                       decoration-success="liquidation_state == 'liquidated'"
                       decoration-warning="liquidation_state == 'pending'"/>
                <field name="is_liquidation" invisible="1"/>
                <field name="original_sheet_id" invisible="1"/>
                <field name="settlement_sheet_id" invisible="1"/>
            </xpath>

            <!-- Botón Liquidar Anticipo (solo en estado 'done' y no es liquidación) -->
            <xpath expr="//header/button[@name='action_register_payment']" position="after">
                <button name="action_settle_advance"
                        string="Settle Advance"
                        type="object"
                        class="btn-primary"
                        attrs="{'invisible': ['|', ('state', '!=', 'done'), ('is_liquidation', '=', True), ('settlement_sheet_id', '!=', False)]}"
                        groups="hr_expense.group_hr_expense_manager"/>
            </xpath>

            <!-- Subtotales de liquidación (solo en hojas de liquidación) -->
            <xpath expr="//field[@name='expense_line_ids']/tree/field[@name='total_amount']" position="after">
                <field name="real_expense"
                       attrs="{'invisible': [('parent.is_liquidation', '=', False)]}"
                       optional="show"/>
                <field name="checked"
                       attrs="{'invisible': [('parent.is_liquidation', '=', False)]}"
                       optional="show"/>
            </xpath>

            <xpath expr="//field[@name='expense_line_ids']/form/group/group[last()]" position="after">
                <group string="Liquidation"
                       attrs="{'invisible': [('parent.is_liquidation', '=', False)]}"
                       col="4">
                    <field name="real_expense"/>
                    <field name="proof" filename="proof_filename"/>
                    <field name="proof" invisible="1"/>
                    <field name="checked" groups="hr_expense.group_hr_expense_manager"/>
                </group>
            </xpath>

            <!-- Totales de liquidación -->
            <xpath expr="//field[@name='expense_line_ids']" position="after">
                <div class="o_form_sheet_bg"
                     attrs="{'invisible': [('is_liquidation', '=', False)]}">
                    <div class="oe_title">
                        <h2>Liquidation Summary</h2>
                    </div>
                    <group>
                        <group>
                            <label for="total_verified_expenses" string="Total Verified Expenses"/>
                            <div>
                                <field name="total_verified_expenses" widget="monetary" readonly="1"/>
                            </div>
                        </group>
                        <group>
                            <label for="refund"
                                   string="Refund"
                                   attrs="{'decoration-danger': [('refund', '&gt;', 0)],
                                           'decoration-bf': [('refund', '&lt;', 0)]}"/>
                            <div>
                                <field name="refund"
                                       widget="monetary"
                                       readonly="1"
                                       attrs="{'decoration-danger': [('refund', '&gt;', 0)],
                                               'decoration-bf': [('refund', '&lt;', 0)]}"/>
                            </div>
                        </group>
                    </group>
                    <div class="alert alert-info"
                         attrs="{'invisible': ['|', ('refund', '&gt;=', 0), ('is_liquidation', '=', False)]}">
                        <strong>Atención:</strong> El reintegro es negativo. Se creará una factura de proveedor al empleado.
                    </div>
                    <div class="alert alert-success"
                         attrs="{'invisible': ['|', ('refund', '&lt;=', 0), ('is_liquidation', '=', False)]}">
                        <strong>Reimbursement in favor of the employee:</strong> A customer invoice will be created to return the excess amount.
                    </div>
                </div>
            </xpath>

        </field>
    </record>

    <!-- Vista de lista para resaltar liquidaciones -->
    <record id="view_expense_sheet_tree_inherit_liquidation" model="ir.ui.view">
        <field name="name">hr.expense.sheet.tree.inherit.liquidation</field>
        <field name="model">hr.expense.sheet</field>
        <field name="inherit_id" ref="hr_expense.view_expense_sheet_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='total_amount']" position="after">
                <field name="is_liquidation" invisible="1"/>
                <field name="liquidation_state" invisible="1"/>
            </xpath>
            <xpath expr="//tree" position="attributes">
                <attribute name="decoration-danger">is_liquidation == True</attribute>
            </xpath>
        </field>
    </record>

    <!-- Settings: Diario de reintegro -->
    <record id="view_res_config_settings_expense_inherit" model="ir.ui.view">
        <field name="name">res.config.settings.view.form.inherit.expense.liquidation</field>
        <field name="model">res.config.settings</field>
        <field name="inherit_id" ref="hr_expense.res_config_settings_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//div[@id='expenses_settings']" position="inside">
                <div class="col-12 col-lg-6 o_setting_box">
                    <div class="o_setting_left_pane"/>
                    <div class="o_setting_right_pane">
                        <label for="expense_reimbursement_journal_id"/>
                        <div class="text-muted">
                            Default accounting journal for expense reimbursement (when the reimbursement is positive)
                        </div>
                        <field name="expense_reimbursement_journal_id"
                               domain="[('type', 'in', ['sale', 'general']), ('company_id', '=', company_id)]"
                               class="oe_inline"/>
                    </div>
                </div>
            </xpath>
        </field>
    </record>

</odoo>